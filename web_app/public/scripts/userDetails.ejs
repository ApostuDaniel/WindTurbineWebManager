<script>
  function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(";");
    for (var i = 0; i < ca.length; i++) {
      var c = ca[i];
      while (c.charAt(0) == " ") c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  }
  var current_password;
  async function putUserData() {
    const user_id = getCookie("user_id");
    const data = await fetch("http://localhost:5000/api/users/" + user_id);
    const user_data = await data.json();
    current_password=user_data.password;
    console.log(user_data);

    var birthdate = new Date(user_data.birthDate);
    var day = birthdate.getDay();
    if (day < 10) {
      day = "0" + day;
    }
    var month = birthdate.getMonth();
    if (month < 10) {
      month = "0" + month;
    }
    const year = birthdate.getFullYear();
    const formedData = year + "-" + month + "-" + day;
    console.log(formedData);

    //put the current values in first form fields

    document
      .getElementById("firstname")
      .setAttribute("value", user_data.firstName);
    document
      .getElementById("secondname")
      .setAttribute("value", user_data.lastName);
    document.getElementById("company").setAttribute("value", user_data.company);
    document.getElementById("cnp").setAttribute("value", user_data.CNP);
    document.getElementById("mail").setAttribute("value", user_data.mail);
    document.getElementById("phone").setAttribute("value", user_data.phone);
    document.getElementById("address").setAttribute("value", user_data.adress);
    document.getElementById("date").setAttribute("value", `${formedData}`);
  }

  async function changeDetails() {
    var firstName = document.getElementById("firstname").value;

    var secondName = document.getElementById("secondname").value;
    var company = document.getElementById("company").value;
    var cnp = document.getElementById("cnp").value;
    var mail = document.getElementById("mail").value;
    var phone = document.getElementById("phone").value;
    var address = document.getElementById("address").value;
    var date = document.getElementById("date").value;
    console.log(mail);
    if (
      firstName == "" ||
      secondName == "" ||
      company == "" ||
      cnp == "" ||
      mail == "" ||
      phone == "" ||
      address == "" ||
      date == ""
    ) {
      document.getElementById("error").innerText =
        "All fields should be filled";
    } else {
      var validationMessage = "";
      if (!firstName.match(/^[A-Za-z ]+$/)) {
        validationMessage =
          "First name is not correct! It should contain only letters";
      }
      if (!secondName.match(/^[A-Za-z ]+$/)) {
        validationMessage =
          "Second name is not correct! It should contain only letters";
      }
      if (!company.match(/[a-zA-Z0-9_/-/.]+$/)) {
        validationMessage = "Company name is not correct!";
      }
      if (!cnp.match(/[0-9]{13}/)) {
        validationMessage = "Cnp should have 13 digits";
      }
      if (!phone.match(/[0-9]{10}/)) {
        validationMessage = "Phone should have 10 digits";
      }
      if (!address.match(/[a-zA-Z0-9_/-/./_ ]+$/)) {
        validationMessage = "Address should be correct";
      }

      if (validationMessage != "") {
        document.getElementById("error").innerText = validationMessage;
      } else {
        password = document.getElementById("newpass").value;
        confirmPassword = document.getElementById("confpass").value;

        if (password != "") {
          if (!password.match(/^[a-zA-Z0-9_/-/./=/_]{8}/)) {
            document.getElementById("passvalidation").innerText =
              "8 characters minimum";
          } else {
            if (password == confirmPassword) {
              // putTheData(
              //   firstName,
              //   secondName,
              //   company,
              //   cnp,
              //   mail,
              //   phone,
              //   address,
              //   current_password,
              // );
              console.log(current_password);
              console.log("s a reusit");
            } else {
              document.getElementById("passvalidation").innerText =
                "password must match";
            }
          }
        } else {
          console.log(password);
          // putTheData(
          //   firstName,
          //   secondName,
          //   company,
          //   cnp,
          //   mail,
          //   phone,
          //   address,
          //   password,
          // );
          console.log("s a reusit");
        }
      }
    }
  }

  async function putTheData(
    firstName,
    secondName,
    company,
    cnp,
    mail,
    phone,
    address,
    pass
  ) {
    const id = getCookie("user_id");
    const newUserData = {
      "firstName": firstName,
      "lastName": secondName,
      "company": company,
      "CNP": cnp,
      "mail": mail,
      "phone": phone,
      "adress"
      : address,
      "password": pass,
    };
    const response = await axios({
      method: "put",
      url: `http://localhost:5000/api/users/${id}`,
      data: JSON.stringify(newUserData),
    })
    console.log(response)
  }

  putUserData();

  function buttonClick() {
    console.log("apasat");
    changeDetails();
  }
</script>
